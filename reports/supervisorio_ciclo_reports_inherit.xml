<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- Extensão do template original de ciclos para adicionar materiais -->
    <template id="report_ciclos_add_materials" inherit_id="afr_supervisorio_ciclos.report_ciclos_template">
        
        <!-- Adiciona seção de materiais após indicador biológico -->
        <xpath expr="//div[@class='row mt-3']" position="before">
            
            <!-- Define quais materiais mostrar: filtrados ou todos -->
            <t t-set="material_ids_filter" t-value="data.get('material_line_ids') if (data and 'material_line_ids' in data) else []"/>
            <t t-set="show_materials" t-value="o.env['afr.supervisorio.cycle.materials.lines'].browse(material_ids_filter) if material_ids_filter else o.material_lines_ids"/>
            
            <!-- DEBUG -->
            <div style="background: yellow; padding: 15px; margin: 10px; border: 3px solid red;">
                <h4 style="color: red;">DEBUG</h4>
                <p>Data: <t t-esc="data"/></p>
                <p>material_ids_filter: <t t-esc="material_ids_filter"/></p>
                <p>Total show_materials: <t t-esc="len(show_materials)"/></p>
                <p>IDs: <t t-esc="show_materials.ids"/></p>
            </div>
            
            <!-- Seção de Materiais -->
            <div class="row mt-4" t-if="show_materials">
                <div class="col-12">
                    <h5 class="mb-3 text-center" style="background-color: #e9ecef; padding: 10px;">
                        MATERIAIS ESTERILIZADOS
                    </h5>
                    <table class="table table-bordered table-sm">
                        <thead style="background-color: #f8f9fa;">
                            <tr>
                                <th class="text-center">Item</th>
                                <th>Produto</th>
                                <th>Fabricante</th>
                                <th>Lote</th>
                                <th class="text-center">Qtd</th>
                                <th>Unidade</th>
                                <th>Validade</th>
                            </tr>
                        </thead>
                        <tbody>
                            <t t-set="item_num" t-value="0"/>
                            <t t-foreach="show_materials" t-as="mat">
                                <t t-set="item_num" t-value="item_num + 1"/>
                                <tr>
                                    <td class="text-center"><t t-esc="item_num"/></td>
                                    <td><span t-field="mat.material_descricao"/></td>
                                    <td><span t-field="mat.fabricante_nome"/></td>
                                    <td><span t-field="mat.lote"/></td>
                                    <td class="text-center"><span t-field="mat.quantidade"/></td>
                                    <td>
                                        <t t-if="mat.unidade == 'caixa'">Caixa</t>
                                        <t t-elif="mat.unidade == 'unidade'">Unidade</t>
                                        <t t-elif="mat.unidade == 'pacote'">Pacote</t>
                                        <t t-elif="mat.unidade == 'envelope'">Envelope</t>
                                        <t t-elif="mat.unidade == 'kit'">Kit</t>
                                        <t t-else="">Outro</t>
                                    </td>
                                    <td><span t-field="mat.validade"/></td>
                                </tr>
                            </t>
                        </tbody>
                    </table>
                </div>
            </div>
            
        </xpath>
        
    </template>
</odoo>

